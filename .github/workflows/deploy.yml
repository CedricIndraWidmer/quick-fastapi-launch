name: Multi-Env Deploy (Staging & Prod)

on:
  push:
    branches: [main]
  workflow_dispatch: # Manual trigger for Production

jobs:
  deploy:
    name: Deploy to ${{ github.event_name == 'push' && 'Staging' || 'Production' }}
    runs-on: ubuntu-latest
    # Selects environment based on the trigger
    environment: ${{ github.event_name == 'push' && 'staging' || 'production' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deployment
          zip -r deployment/app.zip . \
            -x "node_modules/*" ".git/*" ".github/*" "venv/*" ".env*" "*.log" ".DS_Store" "deployment/*"

      - name: Copy package to EC2
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          source: "deployment/app.zip,nginx/fastapi.conf"
          target: ${{ vars.TARGET_DIR }}
          rm: false

      - name: Execute Remote Deployment & Nginx Update
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          # Pass the environment name to the script to determine PM2 flag
          envs: GITHUB_ENV_NAME
          script: |
            set -e
            cd ${{ vars.TARGET_DIR }}

            # 1. Extract Package
            unzip -o deployment/app.zip -d .
            rm deployment/app.zip

            # 2. Update Python Environment
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

            # 3. Update Nginx (Uses sudo - ensure your user has sudo privileges)
            # We copy the config from the repo to Nginx system folders
            sudo cp nginx/fastapi.conf /etc/nginx/sites-available/fastapi-multi
            sudo ln -sf /etc/nginx/sites-available/fastapi-multi /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx

            # 4. Restart PM2 based on environment
            # If triggered by push, use 'staging'. If manual, use 'production'.
            if [ "${{ github.event_name }}" = "push" ]; then
              pm2 start ecosystem.config.js --env staging || pm2 reload ecosystem.config.js --env staging
            else
              pm2 start ecosystem.config.js --env production || pm2 reload ecosystem.config.js --env production
            fi
            pm2 save
