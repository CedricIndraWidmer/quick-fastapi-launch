name: Multi-Env Deploy (Staging & Prod)

on:
  push:
    branches: [main]
  workflow_dispatch: # Manual trigger for Production

jobs:
  deploy:
    name: Deploy to ${{ github.event_name == 'push' && 'Staging' || 'Production' }}
    runs-on: ubuntu-latest
    # Selects environment based on the trigger
    environment: ${{ github.event_name == 'push' && 'staging' || 'production' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deployment
          zip -r deployment/app.zip . \
            -x "nginx/*" "node_modules/*" ".git/*" ".github/*" "venv/*" ".env*" "*.log" ".DS_Store" "deployment/*"

      - name: Copy package to EC2
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          source: "deployment/app.zip,nginx/fastapi.conf"
          target: ${{ vars.TARGET_DIR }}
          rm: false

      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@v1.2.5
        env:
          GITHUB_ENV_NAME: ${{ github.event_name == 'push' && 'staging' || 'production' }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          envs: GITHUB_ENV_NAME
          script: |
            set -e
            cd ${{ vars.TARGET_DIR }}

            # 1. Extract App Package FIRST
            # This ensures the directory is ready and the environment is clean
            unzip -o deployment/app.zip -d .
            rm deployment/app.zip

            # 2. Update Nginx SECOND
            # We move the config now that we are sure the folder structure is solid
            if [ -f "nginx/fastapi.conf" ]; then
                echo "Applying Nginx configuration..."
                sudo cp nginx/fastapi.conf /etc/nginx/sites-available/fastapi-multi
                sudo ln -sf /etc/nginx/sites-available/fastapi-multi /etc/nginx/sites-enabled/
                sudo nginx -t && sudo systemctl reload nginx
                # Clean up the folder we excluded from the zip but sent via SCP
                rm -rf nginx/
            fi

            # 3. Update Python Environment
            echo "Updating Python Environment for $GITHUB_ENV_NAME..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # 4. Restart PM2
            echo "Deploying to environment: $GITHUB_ENV_NAME"
            if [ "$GITHUB_ENV_NAME" = "staging" ]; then
                pm2 delete fastapi-app-staging 2>/dev/null || true
                pm2 start ecosystem.config.js --only fastapi-app-staging
            else
                pm2 delete fastapi-app-prod 2>/dev/null || true
                pm2 start ecosystem.config.js --only fastapi-app-prod
            fi
            pm2 save
